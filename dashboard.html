<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>仪表盘</title>
	<link rel="stylesheet" type="text/css" href="./assets/css/bootstrap.min.css">
	<script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
	<script src="./assets/js/jquery-3.4.1.min.js"></script>
	<script>if (window.module) module = window.module;</script>
	<style>
		.wordsContainer {
			height:400px;
			overflow-y: scroll;
		}
		.wordsContainer::-webkit-scrollbar{
			width:0px;
			opacity:0;
			-webkit-overflow-scrolling: touch;
		}
		.modal {
			width:180px;
		}
		#delWordButton {
			display: none;
			position: fixed;
			z-index: 999;
		}
	</style>
</head>

<body>
 	<div>
		<!--改变字体大小-->
		<div class="input-group">
			<label for="">字体大小</label>
			<input type="number"
				   onkeyup="if (/(\-|\D)/g.test(this.value)) this.value = this.value.replace(/(\-|\D)/g,'')"
				   id="fontSizeInput" class="form-control"  placeholder="添加字体大小" aria-label="change word size" aria-describedby="button-addon4">
			<div class="input-group-append" id="button-addon4">
				<button class="btn btn-outline-secondary" type="button" id="changeWordSizeButtonAdd">+</button>
				<button class="btn btn-outline-secondary" type="button" id="changeWordSizeButtonDel">-</button>
			</div>
		</div>
		<!--改变刷新的时间间隔-->
		<div class="input-group mb-3">
			<label>刷新的时间间隔</label>
			<input type="number" id="timer" class="form-control" placeholder="1000" aria-label="Recipient's username" aria-describedby="button-addon2">
			<div class="input-group-append" id="button-addon3">
				<button class="btn btn-outline-secondary" type="button" id="timerAdd">+</button>
				<button class="btn btn-outline-secondary" type="button" id="timerDel">-</button>
			</div>
		</div>

		<!--words管理-->
		<div class="wordsContainer">
			<div class="input-group mb-3">
				<input id="addWordInput" type="text" class="form-control" placeholder="添加一个word" aria-label="Recipient's username" aria-describedby="button-addon2">
				<div class="input-group-append">
					<button class="btn btn-outline-secondary" type="button" id="buttonForAddWord">添加</button>
				</div>
			</div>
			<ul class="list-group" id="wordsList">
			</ul>
		</div>

		<!-- 删除word -->
		<button type="button" class="btn btn-danger" id="delWordButton" onclick="showDelWordModal()">删除</button>
		<div id="delWordModal" class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="false">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-body">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
						<button type="button" class="btn btn-primary" onclick="delWord()">删除</button>
					</div>
				</div>
			</div>
		</div>
 	</div>
</body>


<script src="./assets/js/popper.min.js"></script>
<script src="./assets/js/bootstrap.min.js" defer></script>
<script src="./util.js"></script>
<script type="text/javascript">
	//初始化配仪表盘页面
    var words = []
    setTimeout(()=>{
        // 设置字体大小
        const wordkit = getConfig()
        var fontSize = wordkit["fontSize"] ? wordkit['fontSize'] : 36
		$("#fontSizeInput").val(fontSize)

		//设置刷新间隔
        var timer = wordkit["timer"] ? wordkit['timer'] : 3000
        $("#timer").val(timer)

		//设置words列表
		let w = wordkit["word"]
        words = w ? w : [""]
		words.forEach(v => {
		    $("#wordsList").append(`<li class="list-group-item">${v}</li>`)
		})
    },500)


	//监听字体大小变化
	$('#changeWordSizeButtonAdd').click(() => {
	    const val = parseInt($("#fontSizeInput").val())
		const ans = val + 1 > 100 ? 100 : val + 1
        $("#fontSizeInput").val(ans)
        setConfig('fontSize',ans)
        sendMsgBetweenRender('Change Font Size',ans)
	})
    $('#changeWordSizeButtonDel').click(() => {
        const val = parseInt($("#fontSizeInput").val())
        const ans = val - 1 > 0 ? val -1 :0
        $("#fontSizeInput").val(ans)
        setConfig('fontSize',ans)
        sendMsgBetweenRender('Change Font Size',ans)
    })
	$("#fontSizeInput").blur(()=>{
        const val = parseInt($("#fontSizeInput").val())
		if(isNaN(val)) {
            $("#fontSizeInput").val(getConfig('fontSize'))
		} else {
            let ans = val > 100 ? 100 : val
            ans = val > 0 ? val : 0
            $("#fontSizeInput").val(ans)
            setConfig('fontSize',ans)
            sendMsgBetweenRender('Change Font Size',ans)
		}
	})

	//监听刷新时间间隔变化
	$("#timerAdd").click(()=>{
        const val = parseInt($("#timer").val())
        const ans = val + 500
        $("#timer").val(ans)
        setConfig('timer',ans)
        sendMsgBetweenRender('Change Timer',ans)
    })
    $("#timerDel").click(()=>{
        const val = parseInt($("#timer").val())
        const ans = val - 500 >= 1000 ? val - 500 : 1000
        $("#timer").val(ans)
        setConfig('timer',ans)
        sendMsgBetweenRender('Change Timer',ans)
    })

	//监听word列表的点击，右键，修改，删除
	var lastchild = null
	var targetToDel = null
	$("#wordsList").on('mousedown','li',function(e){
	    if (e.button == 0) {
	        //左键点击
	        if(this && this === lastchild) {
                $(this).removeClass('active')//??????????????????
				lastchild = null
			} else {
                $(this).addClass('active')//??????????????????
				if(lastchild)  {
                    $(lastchild).removeClass('active')
                }
				lastchild = this
			}
		} else {
            //右键点击
            targetToDel = this
			const x = e.pageX
			const y = e.pageY
			$("#delWordButton").css({'display':"block",'left':`${x}px`, 'top':`${y}px`})
		}
	})
	function showDelWordModal() {
        $("#delWordButton").css({'display':'none'})
        $('#delWordModal').modal('toggle')
	}
	function delWord() {
        //删除单词
		const w = $(targetToDel).text()
        $(targetToDel).remove()
		let words = getConfig('word')
		words = words.filter(v => v !== w)
		setConfig('word',words)
		setTimeout(()=>{
            sendMsgBetweenRender('Del Word')

		},50)
        $('#delWordModal').modal('hide')
	}

	function addwordInDashboard(word) {
		if(words.findIndex(v => v === word) === -1) {
		    words.unshift(word)
			setConfig('word',words)
            $("#wordsList").prepend(`<li class="list-group-item">${word}</li>`)
		}
	}
	$("#addWordInput").keyup(function(e){
        if(e.keyCode == 13)
        {
            addwordInDashboard(e.target.value)
        }
	})
	$("#buttonForAddWord").click(()=>{
	    let word = $("#addWordInput").val()
        addwordInDashboard(word)
	})
</script>
</html>
